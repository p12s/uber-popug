# Домашка к курсу «Асинхронная архитектура»

## Awesome Task Exchange System (aTES) для UberPopug Inc
Таск-трекер с системой автоматического назначения задач и подсчетом зарплаты.

### 0. Черновой проект системы  
[Обновляемая схема](https://lucid.app/lucidchart/4a910662-880b-4a58-b267-bb9159ae6ddd/edit?invitationId=inv_72216676-2985-4601-b150-7aaea1354a03)  

#### Сервисы:  
- Аутентификационный - выносим отдельно, потому что иначе у каждого сервиса придется делать свою аутентификацию и синхронизировать их между собой. Также отдельный сервис аутетификации удобен как в поддержке/развитии (правим код в одном месте), так и отсутствием реализации аутентификации в каждом отдельном сервисе (можно сосредоточиться на бизнес-логике). Однако, в других сервисах может потребоваться реализовать разделение прав, и часть логики по определению пользователя и что этому пользователю можно - придется реализовать.  
- Управление/работа с тасками - отдельно, потому что подходит под отдельную доменную область. Здесь происходит манипуляция жизненным циклом тасков. Над ним может работать отдельный разработчик, тестировать идеи по улучшению производительности попугов, а его эксперименты никак не затронут работу бухгалтерии и аналитиков.
- Аккаунтинг (бухгалтерия) - отдельно. Сервис считает деньги, тут нужна стабильность. 
- Аналитика - тоже. Сюда можно прикрутить ClickHouse и не волноваться, что сломается сервис тасков - главный кормилец бизнеса.  

Пользователи-попуги работают через UI-интерфейс с каждым сервисом в синхронном режиме:  
кликают на создание таска - пока сервис тасков не сохранит в БД данные нового таска, ответ "ОК" не придет.  
А вот взаимодействие между сервисами идет в асинхронном режиме, через шину.  

#### Сервисы и какие данные они отправляют в шину:

- Аутентификационный - ничего не шлет в шину
- Управление/работа с тасками - только публикует события с полями:
```
      "создание таска"
        дата
        описание
        попуг
        сумма списания
      "завершение таска"
        дата
        попуг
        сумма начисления
      "ассайн"
        таск
        попуг
```
- Аккаунтинг - сомневаюсь, стоило ли выделять его в отдельный сервис - много дублирования данных из сервиса Тасков
```
      слушает событие "ассайн" - записываем на счет за что списаны деньги
      слушает "завершение таска" - записываем за что начислены
      публикует "уведомление" - отправка письма попугам в конце дня
```
- Аналитика
```
      слушает "завершение таска"
```

#### Проблемы и что делать если они случатся
- Если сломается фронтенд - никто никуда не сможет войти. Но попуги сразу это увидят и поднимут шум, разрабтчики займутся проблемой.
- Если сломатеся Авторизация - тоже никто никуда не зайдет. Исправлять будут разработчики сервиса, а объяснять, куда смотрели тестировщики - их менеджеры.
- Если сломается отдельно какой-то сервис - аналогично, пишем в команду этого сервиса. Также рекомендуем разработчикам, чтобы сделали работы с БД более отказоустойчивой - например, добавили slave. Тогда в худшем случае, при падении master, пользователи не смогут менять данные, но просмотр останется. Откузоустойчивость самих сервисов проверяем на этапе разработки, даже пробуем нагружать каким-нибудь wrk.
- Отказоустойчивость шины не рассматриваем - перекладываем ее на реализацию.
- Сервис уведомлений работает по принципам откузоустойчивости других сервисов. Но если что-то пойдет не так - необработанные события отправки можно будет прочитать из шины и доделать работу после того, как сревис поднимется.

#### Критичные места
Разделение доменных зон по сервисам позволило уменьшить вероятность каскадного отказа системы. Узким звеном остается Аутентификация - сломается и никто никуда не зайдет.  
Также сомневаюсь, стоило ли выделять Аккаунтинг в отдельный сервис - данные дублируются, бизнес-логика сильно завязана на работу с предыдущим доменом - Тасками
